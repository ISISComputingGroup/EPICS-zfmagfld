record(bo, "$(P)SIM")
{
  field(SCAN, "Passive")
  field(DTYP, "Soft Channel")
  field(ZNAM, "NO")
  field(ONAM, "YES")
  field(VAL, "$(RECSIM=0)")
}

record(bo, "$(P)DISABLE")
{
  field(DESC, "Disable comms")
  field(PINI, "YES")
  field(VAL, "$(DISABLE=0)")
  field(OMSL, "supervisory")
  field(ZNAM, "COMMS ENABLED")
  field(ONAM, "COMMS DISABLED")
}

record(aSub, "$(P)CORRECTFIELD") {
  field(DESC, "Applies calibration matrix op")
  field(SNAM, "matrix_multiply")
  field(SCAN, "Passive")

  field(FLNK, "$(SQNCR="$(PVPREFIX):ZFCNTRL_01:INPUTS_UPDATED.PROC")")

  # Offset-shifted data from magnetometer
  field(INPA, "$(P)X:APPLYOFFSET MS")
  field(FTA, "DOUBLE")
  
  field(INPB, "$(P)Y:APPLYOFFSET MS")
  field(FTB, "DOUBLE")
  
  field(INPC, "$(P)Z:APPLYOFFSET MS")
  field(FTC, "DOUBLE")
  
  # Sensor matrix values
  field(INPD, "$(P)SENSORMATRIX:11")
  field(FTD, "DOUBLE")
  
  field(INPE, "$(P)SENSORMATRIX:12")
  field(FTE, "DOUBLE")
  
  field(INPF, "$(P)SENSORMATRIX:13")
  field(FTF, "DOUBLE")
  
  field(INPG, "$(P)SENSORMATRIX:21")
  field(FTG, "DOUBLE")
  
  field(INPH, "$(P)SENSORMATRIX:22")
  field(FTH, "DOUBLE")
  
  field(INPI, "$(P)SENSORMATRIX:23")
  field(FTI, "DOUBLE")
  
  field(INPJ, "$(P)SENSORMATRIX:31")
  field(FTJ, "DOUBLE")
  
  field(INPK, "$(P)SENSORMATRIX:32")
  field(FTK, "DOUBLE")
  
  field(INPL, "$(P)SENSORMATRIX:33")
  field(FTL, "DOUBLE")
  
  # Corrected field
  field(OUTA, "$(P)X:CORRECTEDFIELD:RAW.A PP")
  field(FTVA, "DOUBLE")

  field(OUTB, "$(P)Y:CORRECTEDFIELD:RAW.A PP")
  field(FTVB, "DOUBLE")

  field(OUTC, "$(P)Z:CORRECTEDFIELD:RAW.A PP")
  field(FTVC, "DOUBLE")

  field(OUTD, "$(P)FIELDSTRENGTH:RAW.A PP")
  field(FTVD, "DOUBLE")

}

record(ai, "$(P)FIELDSTRENGTH"){
  field(DESC, "Corrected field magnitude")

  field(PREC, "3")
}

record(calc, "$(P)OVERLOAD"){
  field(DESC, "1 if magnetometer overloaded")

  field(CALC, "max(A, B, C) > (D * 4.5)")

  field(INPA, "$(P)MEASURED:X MS")
  field(INPB, "$(P)MEASURED:Y MS")
  field(INPC, "$(P)MEASURED:Z MS")
  field(INPD, "$(P)RANGE")

  field(HIGH, "1")
  field(HSV, "MAJOR")

  field(FLNK, "$(P)CORRECTFIELD")
}

record(ai, "$(P)RANGE"){
  field(DESC, "Scale factor for magnetometer range")
  field(VAL, "$(RANGE=1)")
}

alias("$(P)DAQ:X:_RAW", "$(P)TAKEDATA")
